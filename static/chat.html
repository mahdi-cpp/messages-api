<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Application with Rooms</title>
    <style>
        /* Add these styles to your existing CSS */

        .rooms-sidebar {
            width: 250px;
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            overflow-y: auto;
        }

        .rooms-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .create-room-btn {
            background-color: #27ae60;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
        }

        .room-list {
            list-style: none;
            padding: 0;
        }

        .room-item {
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .room-item:hover {
            background-color: #34495e;
        }

        .room-item.active {
            background-color: #3498db;
        }

        .main-chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-container {
            display: flex;
            height: 100vh;
        }

        /* Modal styles for creating rooms */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 300px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
        }

        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }
    </style>
</head>
<body>

<div class="chat-container">
    <div class="rooms-sidebar">
        <div class="rooms-header">
            <h3>Rooms</h3>
            <button class="create-room-btn" id="create-room-btn">+</button>
        </div>
        <ul class="room-list" id="room-list">
            <li class="room-item active" data-room-id="general">General</li>
            <!-- Rooms will be populated dynamically -->
        </ul>
    </div>

    <div class="main-chat-area">
        <div class="chat-header">
            <div class="chat-title" id="current-room">General</div>
            <div class="online-indicator">
                <div class="online-dot"></div>
                <span id="online-count">0 online</span>
            </div>
        </div>

        <div class="chat-messages" id="chat-messages">
            <div class="typing-indicator" id="typing-indicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>

        <div class="connection-status" id="connection-status">
            <span class="disconnected">Disconnected</span>
        </div>

        <div class="chat-input-container">
                <textarea
                        class="message-input"
                        id="message-input"
                        placeholder="Type a message..."
                        rows="1"
                ></textarea>
            <button class="send-button" id="send-button">
                <svg viewBox="0 0 24 24">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
                </svg>
            </button>
        </div>
    </div>
</div>

<!-- Create Room Modal -->
<div class="modal" id="create-room-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create New Room</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="form-group">
            <label for="room-name">Room Name</label>
            <input type="text" id="room-name" placeholder="Enter room name">
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" id="cancel-create-room">Cancel</button>
            <button class="btn btn-primary" id="confirm-create-room">Create</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {

        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.getElementById('typing-indicator');
        const connectionStatus = document.getElementById('connection-status');
        const onlineCount = document.getElementById('online-count');
        const roomList = document.getElementById('room-list');
        const createRoomBtn = document.getElementById('create-room-btn');
        const createRoomModal = document.getElementById('create-room-modal');
        const cancelCreateRoom = document.getElementById('cancel-create-room');
        const confirmCreateRoom = document.getElementById('confirm-create-room');
        const roomNameInput = document.getElementById('room-name');
        const currentRoomElement = document.getElementById('current-room');

        let ws;
        let typingTimer;
        const TYPING_TIMEOUT = 3000;
        const currentUser = generateRandomUser();
        let isConnected = false;
        let currentRoom = 'general';
        let roomMessages = {}; // Store messages by room ID

        // Initialize WebSocket connection
        connectWebSocket();

        function connectWebSocket() {

            // Replace the simulated connection with a real WebSocket object
            ws = new WebSocket('ws://localhost:8099');

            // In a real application, you would connect to your WebSocket server
            console.log('Connecting to WebSocket server...');

            // Simulate connection success
            setTimeout(() => {
                isConnected = true;
                updateConnectionStatus(true);
                addSystemMessage('Connected to chat');

                // Join the default room
                joinRoom('general');

                // Request room list
                setTimeout(() => {
                    // Simulate receiving room list
                    handleRoomList({
                        general: 'General',
                        random: 'Random Chat',
                        tech: 'Technology',
                        games: 'Gaming'
                    });
                }, 500);
            }, 1000);
        }

        function joinRoom(roomId) {
            // Leave current room if joined to another
            if (currentRoom && currentRoom !== roomId) {
                // Send leave room message (in real implementation)
                // ws.send(JSON.stringify({
                //     type: 'leave_room',
                //     roomId: currentRoom
                // }));
            }

            // Update current room
            currentRoom = roomId;
            currentRoomElement.textContent = getRoomName(roomId);

            // Update UI to show active room
            document.querySelectorAll('.room-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-room-id') === roomId) {
                    item.classList.add('active');
                }
            });

            // Clear chat messages
            chatMessages.innerHTML = '<div class="typing-indicator" id="typing-indicator"><span></span><span></span><span></span></div>';

            // Load messages for this room
            if (roomMessages[roomId]) {
                roomMessages[roomId].forEach(message => {
                    addMessageToUI(message, message.userId === currentUser.id);
                });
            }

            // Send join room message (in real implementation)
            // ws.send(JSON.stringify({
            //     type: 'join_room',
            //     roomId: roomId
            // }));

            scrollToBottom();
        }

        function createRoom(roomName) {
            const roomId = generateSlug(roomName);

            // In real implementation, send to server:
            ws.send(JSON.stringify({
                type: 'create_room',
                roomId: roomId,
                roomName: roomName
            }));

            // For demo, just add to UI
            addRoomToList(roomId, roomName);
            joinRoom(roomId);

            // Close modal
            createRoomModal.style.display = 'none';
            roomNameInput.value = '';
        }

        function handleRoomList(rooms) {
            // Clear existing rooms (except default ones)
            const roomItems = roomList.querySelectorAll('.room-item');
            roomItems.forEach(item => {
                const roomId = item.getAttribute('data-room-id');
                if (roomId !== 'general') {
                    item.remove();
                }
            });

            // Add rooms to list
            for (const [id, name] of Object.entries(rooms)) {
                if (id !== 'general') {
                    addRoomToList(id, name);
                }
            }
        }

        function addRoomToList(roomId, roomName) {
            const roomItem = document.createElement('li');
            roomItem.className = 'room-item';
            roomItem.setAttribute('data-room-id', roomId);
            roomItem.textContent = roomName;

            roomItem.addEventListener('click', function() {
                joinRoom(roomId);
            });

            roomList.appendChild(roomItem);
        }

        function getRoomName(roomId) {
            const roomItem = roomList.querySelector(`[data-room-id="${roomId}"]`);
            return roomItem ? roomItem.textContent : roomId;
        }

        // Event listeners for room management
        createRoomBtn.addEventListener('click', function() {
            createRoomModal.style.display = 'flex';
        });

        cancelCreateRoom.addEventListener('click', function() {
            createRoomModal.style.display = 'none';
            roomNameInput.value = '';
        });

        confirmCreateRoom.addEventListener('click', function() {
            const roomName = roomNameInput.value.trim();
            if (roomName) {
                createRoom(roomName);
            }
        });

        document.querySelector('.close-modal').addEventListener('click', function() {
            createRoomModal.style.display = 'none';
            roomNameInput.value = '';
        });

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target === createRoomModal) {
                createRoomModal.style.display = 'none';
                roomNameInput.value = '';
            }
        });

        // Modify message handling to include room context
        function sendMessage() {
            const content = messageInput.value.trim();
            if (!content || !isConnected) return;

            const message = {
                type: 'message',
                id: generateUUID(),
                userId: currentUser.id,
                username: currentUser.username,
                content: content,
                chatId: currentRoom, // Send to current room
                timestamp: new Date()
            };

            // Store message in room-specific storage
            if (!roomMessages[currentRoom]) {
                roomMessages[currentRoom] = [];
            }
            roomMessages[currentRoom].push(message);

            // Add to UI
            addMessageToUI(message, true);

            // In real implementation, send via WebSocket:
            // ws.send(JSON.stringify(message));

            // Clear input and reset height
            messageInput.value = '';
            messageInput.style.height = 'auto';

            // Simulate receiving responses in the same room
            if (Math.random() > 0.3) {
                setTimeout(() => {
                    const responses = [
                        "That's interesting!",
                        "I see what you mean.",
                        "Thanks for sharing!",
                        "I agree with you.",
                        "Can you tell me more about that?",
                        "That's great to hear!"
                    ];

                    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                    const randomUser = ['Alice', 'Bob', 'Charlie', 'Diana', 'Eva'][Math.floor(Math.random() * 5)];

                    const responseMessage = {
                        id: generateUUID(),
                        userId: 'user' + Math.floor(Math.random() * 5 + 2),
                        username: randomUser,
                        content: randomResponse,
                        chatId: currentRoom,
                        timestamp: new Date()
                    };

                    // Store and display response
                    if (!roomMessages[currentRoom]) {
                        roomMessages[currentRoom] = [];
                    }
                    roomMessages[currentRoom].push(responseMessage);
                    addMessageToUI(responseMessage, false);
                }, 1000 + Math.random() * 2000);
            }
        }

        // Update message handling to check room ID
        function receiveMessage(message) {
            // Only display if message is for current room
            if (message.chatId === currentRoom) {
                addMessageToUI(message, false);
            }

            // Store message regardless of current room
            if (!roomMessages[message.chatId]) {
                roomMessages[message.chatId] = [];
            }
            roomMessages[message.chatId].push(message);
        }

        // Keep the rest of your existing functions (addMessageToUI, addSystemMessage, etc.)
        // ... (existing code remains the same)

        // Utility function to generate URL-friendly slug
        function generateSlug(text) {
            return text.toString().toLowerCase()
                .replace(/\s+/g, '-')           // Replace spaces with -
                .replace(/[^\w\-]+/g, '')       // Remove all non-word chars
                .replace(/\-\-+/g, '-')         // Replace multiple - with single -
                .replace(/^-+/, '')             // Trim - from start of text
                .replace(/-+$/, '');            // Trim - from end of text
        }

    });

</script>
</body>
</html>