<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Application with Chats</title>
    <style>
        /* Add these styles to your existing CSS */

        .chats-sidebar {
            width: 250px;
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            overflow-y: auto;
        }

        .chats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .create-chat-btn {
            background-color: #27ae60;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
        }

        .chat-list {
            list-style: none;
            padding: 0;
        }

        .chat-item {
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .chat-item:hover {
            background-color: #34495e;
        }

        .chat-item.active {
            background-color: #3498db;
        }

        .main-chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-container {
            display: flex;
            height: 100vh;
        }

        /* Modal styles for creating chats */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 300px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
        }

        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }
    </style>
</head>
<body>

<div class="chat-container">
    <div class="chats-sidebar">
        <div class="chats-header">
            <h3>Chats</h3>
            <button class="create-chat-btn" id="create-chat-btn">+</button>
        </div>
        <ul class="chat-list" id="chat-list">
            <li class="chat-item active" data-chat-id="general">General</li>
            <!-- Chats will be populated dynamically -->
        </ul>
    </div>

    <div class="main-chat-area">
        <div class="chat-header">
            <div class="chat-title" id="current-chat">General</div>
            <div class="online-indicator">
                <div class="online-dot"></div>
                <span id="online-count">0 online</span>
            </div>
        </div>

        <div class="chat-messages" id="chat-messages">
            <div class="typing-indicator" id="typing-indicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>

        <div class="connection-status" id="connection-status">
            <span class="disconnected">Disconnected</span>
        </div>

        <div class="chat-input-container">
                <textarea
                        class="message-input"
                        id="message-input"
                        placeholder="Type a message..."
                        rows="1"
                ></textarea>
            <button class="send-button" id="send-button">
                <svg viewBox="0 0 24 24">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
                </svg>
            </button>
        </div>
    </div>
</div>

<!-- Create Chat Modal -->
<div class="modal" id="create-chat-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create New Chat</h3>
            <button class="close-modal">&times;</button>
        </div>
        <div class="form-group">
            <label for="chat-name">Chat Name</label>
            <input type="text" id="chat-name" placeholder="Enter chat name">
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" id="cancel-create-chat">Cancel</button>
            <button class="btn btn-primary" id="confirm-create-chat">Create</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {

        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.getElementById('typing-indicator');
        const connectionStatus = document.getElementById('connection-status');
        const onlineCount = document.getElementById('online-count');
        const chatList = document.getElementById('chat-list');
        const createChatBtn = document.getElementById('create-chat-btn');
        const createChatModal = document.getElementById('create-chat-modal');
        const cancelCreateChat = document.getElementById('cancel-create-chat');
        const confirmCreateChat = document.getElementById('confirm-create-chat');
        const chatNameInput = document.getElementById('chat-name');
        const currentChatElement = document.getElementById('current-chat');

        let ws;
        let typingTimer;
        const TYPING_TIMEOUT = 3000;
        const currentUser = generateRandomUser();
        let isConnected = false;
        let currentChat = 'general';
        let chatMessages = {}; // Store message by chat ID

        // Initialize WebSocket connection
        connectWebSocket();

        function connectWebSocket() {

            // Replace the simulated connection with a real WebSocket object
            ws = new WebSocket('ws://localhost:8099');

            // In a real application, you would connect to your WebSocket server
            console.log('Connecting to WebSocket server...');

            // Simulate connection success
            setTimeout(() => {
                isConnected = true;
                updateConnectionStatus(true);
                addSystemMessage('Connected to chat');

                // Join the default chat
                joinChat('general');

                // Request chat list
                setTimeout(() => {
                    // Simulate receiving chat list
                    handleChatList({
                        general: 'General',
                        random: 'Random Chat',
                        tech: 'Technology',
                        games: 'Gaming'
                    });
                }, 500);
            }, 1000);
        }

        function joinChat(chatId) {
            // Leave current chat if joined to another
            if (currentChat && currentChat !== chatId) {
                // Send leave chat message (in real implementation)
                // ws.send(JSON.stringify({
                //     type: 'leave_chat',
                //     chatId: currentChat
                // }));
            }

            // Update current chat
            currentChat = chatId;
            currentChatElement.textContent = getChatName(chatId);

            // Update UI to show active chat
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-chat-id') === chatId) {
                    item.classList.add('active');
                }
            });

            // Clear chat message
            chatMessages.innerHTML = '<div class="typing-indicator" id="typing-indicator"><span></span><span></span><span></span></div>';

            // Load message for this chat
            if (chatMessages[chatId]) {
                chatMessages[chatId].forEach(message => {
                    addMessageToUI(message, message.userId === currentUser.id);
                });
            }

            // Send join chat message (in real implementation)
            // ws.send(JSON.stringify({
            //     type: 'join_chat',
            //     chatId: chatId
            // }));

            scrollToBottom();
        }

        function createChat(chatName) {
            const chatId = generateSlug(chatName);

            // In real implementation, send to server:
            ws.send(JSON.stringify({
                type: 'create_chat',
                chatId: chatId,
                chatName: chatName
            }));

            // For demo, just add to UI
            addChatToList(chatId, chatName);
            joinChat(chatId);

            // Close modal
            createChatModal.style.display = 'none';
            chatNameInput.value = '';
        }

        function handleChatList(chats) {
            // Clear existing chats (except default ones)
            const chatItems = chatList.querySelectorAll('.chat-item');
            chatItems.forEach(item => {
                const chatId = item.getAttribute('data-chat-id');
                if (chatId !== 'general') {
                    item.remove();
                }
            });

            // Add chats to list
            for (const [id, name] of Object.entries(chats)) {
                if (id !== 'general') {
                    addChatToList(id, name);
                }
            }
        }

        function addChatToList(chatId, chatName) {
            const chatItem = document.createElement('li');
            chatItem.className = 'chat-item';
            chatItem.setAttribute('data-chat-id', chatId);
            chatItem.textContent = chatName;

            chatItem.addEventListener('click', function() {
                joinChat(chatId);
            });

            chatList.appendChild(chatItem);
        }

        function getChatName(chatId) {
            const chatItem = chatList.querySelector(`[data-chat-id="${chatId}"]`);
            return chatItem ? chatItem.textContent : chatId;
        }

        // Event listeners for chat management
        createChatBtn.addEventListener('click', function() {
            createChatModal.style.display = 'flex';
        });

        cancelCreateChat.addEventListener('click', function() {
            createChatModal.style.display = 'none';
            chatNameInput.value = '';
        });

        confirmCreateChat.addEventListener('click', function() {
            const chatName = chatNameInput.value.trim();
            if (chatName) {
                createChat(chatName);
            }
        });

        document.querySelector('.close-modal').addEventListener('click', function() {
            createChatModal.style.display = 'none';
            chatNameInput.value = '';
        });

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target === createChatModal) {
                createChatModal.style.display = 'none';
                chatNameInput.value = '';
            }
        });

        // Modify message handling to include chat context
        function sendMessage() {
            const content = messageInput.value.trim();
            if (!content || !isConnected) return;

            const message = {
                type: 'message',
                id: generateUUID(),
                userId: currentUser.id,
                username: currentUser.username,
                content: content,
                chatId: currentChat, // Send to current chat
                timestamp: new Date()
            };

            // Store message in chat-specific storage
            if (!chatMessages[currentChat]) {
                chatMessages[currentChat] = [];
            }
            chatMessages[currentChat].push(message);

            // Add to UI
            addMessageToUI(message, true);

            // In real implementation, send via WebSocket:
            // ws.send(JSON.stringify(message));

            // Clear input and reset height
            messageInput.value = '';
            messageInput.style.height = 'auto';

            // Simulate receiving responses in the same chat
            if (Math.random() > 0.3) {
                setTimeout(() => {
                    const responses = [
                        "That's interesting!",
                        "I see what you mean.",
                        "Thanks for sharing!",
                        "I agree with you.",
                        "Can you tell me more about that?",
                        "That's great to hear!"
                    ];

                    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                    const randomUser = ['Alice', 'Bob', 'Charlie', 'Diana', 'Eva'][Math.floor(Math.random() * 5)];

                    const responseMessage = {
                        id: generateUUID(),
                        userId: 'user' + Math.floor(Math.random() * 5 + 2),
                        username: randomUser,
                        content: randomResponse,
                        chatId: currentChat,
                        timestamp: new Date()
                    };

                    // Store and display response
                    if (!chatMessages[currentChat]) {
                        chatMessages[currentChat] = [];
                    }
                    chatMessages[currentChat].push(responseMessage);
                    addMessageToUI(responseMessage, false);
                }, 1000 + Math.random() * 2000);
            }
        }

        // Update message handling to check chat ID
        function receiveMessage(message) {
            // Only display if message is for current chat
            if (message.chatId === currentChat) {
                addMessageToUI(message, false);
            }

            // Store message regardless of current chat
            if (!chatMessages[message.chatId]) {
                chatMessages[message.chatId] = [];
            }
            chatMessages[message.chatId].push(message);
        }

        // Keep the rest of your existing functions (addMessageToUI, addSystemMessage, etc.)
        // ... (existing code remains the same)

        // Utility function to generate URL-friendly slug
        function generateSlug(text) {
            return text.toString().toLowerCase()
                .replace(/\s+/g, '-')           // Replace spaces with -
                .replace(/[^\w\-]+/g, '')       // Remove all non-word chars
                .replace(/\-\-+/g, '-')         // Replace multiple - with single -
                .replace(/^-+/, '')             // Trim - from start of text
                .replace(/-+$/, '');            // Trim - from end of text
        }

    });

</script>
</body>
</html>